{"version":3,"sources":["../../src/controllers/user.server.controller.js"],"names":["generateToken","u","fullName","user","email","_id","picture","token","sign","algorithm","expiresIn","err","getUsers","req","res","console","log","JSON","stringify","json","success","message","authenticate","next","headers","status","verify","registerUser","body","newUser","fullname","password","profileType","save","name","loginUser","findOne","comparePassword","isMatch","loginWithSocial","id","provider","profileId","gender","findOrCreateFBUser","profile","done","displayName","emails","value","addBookMarkInUser","bM","bm","updateOne","$push","bookMarks","exec","result","removeBookMarkFromUser","qb","qbBm","$pull"],"mappings":"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","file":"user.server.controller.js","sourcesContent":["// ./user-expressjs-backend/controllers/user.server.controller.js\nimport jwt from 'jsonwebtoken';\n\n//import models\nimport User from '../models/user.server.model';\n\nvar generateToken = user => {\n  let u = {\n    fullName: user.fullName,\n    email:user.email,\n    _id:user._id,\n    picture:user.picture\n  }\n  const token = jwt.sign(u, 'my-secret', { algorithm: 'HS384' } ,{\n     expiresIn: 60 * 60 * 1 // expires in 1 hours\n  },(err,token) => token);\n\n  return token;\n}\n\nexport const getUsers = (req,res) => {\n  console.log('User: '+ JSON.stringify(req.user));\n  return res.json({success:true, message:'Authenticated Successfully', user:req.user});\n}\n\n\n//middleware that checks if JWT token exists and verifies it if it does exist.\nexport const authenticate = (req,res,next) => {\n  // check header or url parameters or post parameters for token\n  var token = req.headers['authorization'];\n  if(!token){\n    return res.status(401).json({\n        success: false,\n        message: 'Please Log in using a valid email & password'\n      });\n  }\n  //token = token.replace('Bearer', '');\n  jwt.verify(token, 'my-secret', (err,user) => {\n    if(err){\n      return res.status(401).json({\n        success: false,\n        message: 'Please Log in using a valid email & password'\n      });\n    } else {\n      req.user = user;\n      next();\n    }\n  })\n\n}\n\nexport const registerUser = (req,res) => {\n  console.log(req.body);\n   var newUser = new User({\n     fullName:req.body.fullname,\n     email:req.body.email,\n     password:req.body.password,\n     profileType:'local'\n   });\n   newUser.save((err,user) => {\n     if(err){\n       if(err.name = 'validationError'){\n         return res.json({success:false,message:'Email already taken'});\n       }\n       else{\n         return res.json({success:false,message:'Something going wrong'});\n       }\n     }\n     var token = generateToken(user);\n     return res.json({\n       success:true,\n       message:'Registered Successfully',\n       token\n     });\n   })\n}\n\nexport const loginUser = (req,res) => {\n  if(!req.body.email || !req.body.password){\n\t\tres.json({ success: false, message: 'Please enter username and password'});\n\t}\n   console.log(req.body.password);\n   User.findOne({email:req.body.email}, (err,user) => {\n     if(err){\n       return res.json({success:false,message:'Something going wrong'});\n     }\n     if(!user){\n        return res.json({success:false, message:'Invalid Email'});\n     }\n     else{\n       user.comparePassword(req.body.password,(err,isMatch) => {\n         if(!err && isMatch){\n           var token = generateToken(user);\n           return res.json({success:true, message:'Authenticated Successfully', user, token});\n         }\n         else{\n           return res.json({success:false, message:'Invalid Password'});\n         }\n       });\n     }\n   })\n}\n\nexport const loginWithSocial = (req,res) => {console.log(req.body)\n  if (req.body.email && req.body.id) {\n    // Look up user by profile id\n      var u;\n      User.findOne({profileType: req.body.provider, profileId: req.body.id},(err,user) => {\n        if(err) {\n          return res.json({success:false,message:'Something going wrong'});\n        }\n\n        // Create a new user in the user table if not found\n        if (!user) {\n          var newUser = new User({\n            fullName: req.body.name,\n            email: req.body.email,\n            profileId: req.body.id,\n            profileType: req.body.provider,\n            gender: req.body.gender,\n            picture: req.body.picture,\n            password: req.body.id\n          });\n\n          newUser.save((err,user) => {\n            if(err) {\n                 return res.json({success:false,message:'Something going wrong'});\n            }\n            else{\n              u =  user;\n              var token = generateToken(u);\n              return res.json({\n                success:true,\n                message:'Registered Successfully',\n                token\n              });\n            }\n          });\n\n        }\n        else{ //if user exists in database\n          u = user;\n          var token = generateToken(u);\n          return res.json({\n            success:true,\n            message:'Registered Successfully',\n            token\n          });\n        }\n\n      });\n\n  }\n}\n\nexport const  findOrCreateFBUser = (profile,done) => {\n        if (profile) {\n          // Look up user by profile id\n            var u;\n            User.findOne({profileType: profile.provider, profileId: profile.id},(err,user) => {\n              if(err) {\n                return done(err);\n              }\n\n              // Create a new user in the user table if not found\n              if (!user) {console.log(profile);\n                var newUser = new User({\n                  fullName: profile.displayName,\n                  email: profile.emails[0].value,\n                  profileId: profile.id,\n                  profileType: profile.provider,\n                  gender: profile.gender,\n                  picture: `https://graph.facebook.com/${profile.id}/picture?type=large`,\n                  password: '1234'\n                });\n\n                newUser.save((err,user) => {\n                  if(err) {\n                    return done(err);\n                  }\n                  else{\n                    u =  user;\n                    var token = generateToken(u);\n                    return done(null,token);\n                  }\n                });\n\n              }\n              else{ //if user exists in database\n                u = user;\n                var token = generateToken(u);\n                return done(null,token);\n              }\n\n            });\n\n        }\n      };\n\nexport const addBookMarkInUser = (req,res,next) => {\n  console.log('addBookMarkInUser: '+ JSON.stringify(req.body));\n  let bM = req.bm._id;\n  let user = req.bm.user;\n  if(bM){\n    User.updateOne(\n      { _id:user },\n      { $push:{ bookMarks:bM } }\n    ).exec((err,result) => {\n      if(err) {\n        return res.json({success:false,message:'Something going wrong'});\n   }\n   else{\n    return res.json({\n      success:true,\n      message:'Question Bank Added to Your Bookmarked Qestion Banks.',\n      bm:req.bm\n    });\n   }\n    })\n  }\n}\n\nexport const removeBookMarkFromUser = (req,res,next) => {\n  console.log('removeBookMarkFromUser: '+ JSON.stringify(req.qb));\n  let bM = req.qbBm._id;\n  let user = req.qbBm.user;\n  if (bM && user) {\n    User.updateOne(\n      { _id:user },\n      { $pull:{ bookMarks:bM } }\n    ).exec((err,result) => {\n      if(err) {\n        return res.json({success:false,message:'Something going wrong'});\n   }\n   else{\n    return res.json({success:true,message:'Question Bank Removed From Your BookMarks ',qb:req.qbBm});\n   }\n    })\n  }\n}\n"]}